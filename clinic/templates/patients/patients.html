{% extends "base.html" %}
{% block body %}
<style>
/* ===== Patients page: app-like behavior ===== */

/* Disable text selection on patient UI */
.top-banner,
.top-banner *,
.controls-bar,
.controls-bar *,
.table-container,
.table-container *,
.patients-table,
.patients-table * {
    user-select: none;
    cursor: default;
}

/* Patient row hover */
.patients-table tbody tr:hover {
    background: #f9fafb;
}

/* Enable pointer for actions */
a,
.btn-view,
.btn-upload,
.btn-cert,
.btn-add {
    cursor: pointer;
    user-select: none;
}

/* Inputs usable */
.search-box,
.date-box,
input {
    user-select: text;
    cursor: text;
}

/* Images not selectable */
.patient-mini {
    user-select: none;
    pointer-events: none;
}

.filter-bar {
    background: white;
    padding: 14px;
    border-radius: 10px;
    margin-bottom: 18px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.search-box {
    padding: 9px;
    width: 230px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

/* Reset button */
.btn-reset {
    padding: 9px 14px;
    border-radius: 8px;
    background: #ae5b5b;
    color: white;
    text-decoration: none;
    border: 2px solid black;
    font-weight: 500;
    margin-left: 6px;
}

/* ===============================
   SCROLL FIX (CSS)
   =============================== */

/* ===============================
   FIXED HEADER (NO OVERLAP)
   =============================== */

.patients-fixed-header {
    position: sticky;
    top: 0;
    z-index: 20;
    background: #f4f6f9;
    padding-bottom: 14px;
    margin-bottom: 8px;
}


/* Only patient list scrolls */
.table-container {
    background: white;
    border-radius: 12px;
    overflow-y: auto;
    max-height: calc(100vh - 320px);
    padding: 8px 0 12px 0;
}



/* Sticky table header */




.table-container {
    scroll-behavior: smooth;
}
.patients-table {
    margin-bottom: 12px;
}

.patients-table {
    border-collapse: separate;
    border-spacing: 0;
}
/* ===============================
   KEYBOARD NAVIGATION
   =============================== */

.patients-table tbody tr.kb-active {
    background: #eaf2ff !important;
    outline: 2px solid #2563eb;
    outline-offset: -2px;
}

.patients-table tbody tr.kb-active td {
    background: transparent;
}

/* ===============================
   STICKY TABLE HEADER (NO OVERLAP)
================================ */

.patients-table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #ffffff;

    height: 56px;          /* IMPORTANT */
    padding: 12px 14px;
    box-sizing: border-box;
}
.table-container.scrolled thead th {
    box-shadow: 0 3px 8px rgba(0,0,0,0.12);
}

</style>

<h1 class="page-title">Patients</h1>

<!-- TOP DOCTOR HEADER -->
<div class="top-banner light-orange">
    <div>
        <h2 class="doctor-title">Dr. {{ session['user_email'] }}</h2>
        <p class="subtitle">Manage all patient records in one place</p>
    </div>

    <div class="right-buttons">
        <a href="{{ url_for('patients_bp.add_patient') }}" class="btn-add">
            + Add New Patient
        </a>
    </div>
</div>

<!-- FILTER BAR -->
<form method="GET" class="controls-bar">
    <input type="text"
           name="q"
           class="search-box"
           placeholder="Search by name or phoneâ€¦"
           value="{{ request.args.get('q','') }}">

    <input type="date"
           name="date"
           class="date-box"
           value="{{ request.args.get('date','') }}"
           onchange="this.form.submit()">

    <button class="btn btn-primary" type="submit">Filter</button>

    <a href="{{ url_for('patients_bp.patients') }}"
       class="btn btn-reset">
        Reset
    </a>
</form>

<!-- PATIENT TABLE -->
<div class="table-container">
<table class="patients-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Contact</th>
            <th>Issue</th>
            <th>Last Visit</th>
            <th style="text-align:center;">Actions</th>
        </tr>
    </thead>

    <tbody id="patientTable">
        {% if patients %}
            {% for p in patients %}
            <tr>
                <td>{{ p.patient_no }}</td>

                <td>
                    <div class="patient-info">
                        <img src="{{ url_for('static', filename='patient_images/' + p.image) }}"
                             class="patient-mini">
                        <div>
                            <strong>{{ p.name }}</strong>
                            <p class="subtext">{{ p.gender }}, {{ p.age }} yrs</p>
                        </div>
                    </div>
                </td>

                <td>{{ p.phone }}</td>
                <td>{{ p.disease }}</td>
                <td>{{ p.last_visit }}</td>

                <td class="action-buttons">
                    <a href="{{ url_for('patients_bp.patient_profile', id=p.id) }}" class="btn-view">View</a>
                    <a href="{{ url_for('patients_bp.upload_record', id=p.id) }}" class="btn-upload">Record</a>
                    <a href="{{ url_for('patients_bp.generate_certificate', id=p.id) }}" class="btn-cert">Certificate</a>
                </td>
            </tr>
            {% endfor %}
        {% else %}
        <tr>
            <td colspan="6" class="empty-state">
                <img src="{{ url_for('static', filename='images/empty.png') }}" width="150">
                <p>No patients found</p>
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>
</div>

<script src="{{ url_for('static', filename='js/patients/patient_search.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const tableContainer = document.querySelector(".table-container");
    const tbody = document.querySelector("#patientTable");

    if (!tableContainer || !tbody) return;

    let rows = Array.from(tbody.querySelectorAll("tr"));
    let index = -1;
    let keyboardActive = false;

    // ---------- HELPERS ----------
    function clearActive() {
        rows.forEach(r => r.classList.remove("kb-active"));
    }

    function activate(i) {
        if (!rows.length) return;

        index = Math.max(0, Math.min(i, rows.length - 1));
        clearActive();

        const row = rows[index];
        row.classList.add("kb-active");

        // ensure row visible
        row.scrollIntoView({
            block: "nearest",
            behavior: "smooth"
        });
    }

    // ---------- MOUSE SUPPORT ----------
    rows.forEach((row, i) => {
        row.addEventListener("click", () => {
            keyboardActive = true;
            activate(i);
        });
    });

    // ---------- KEYBOARD NAV ----------
    document.addEventListener("keydown", e => {

        // ignore typing inside inputs
        if (["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) {
            return;
        }

        if (!rows.length) return;

        if (!keyboardActive) {
            keyboardActive = true;
            activate(0);
            return;
        }

        switch (e.key) {

            case "ArrowDown":
                e.preventDefault();
                activate(index + 1);
                break;

            case "ArrowUp":
                e.preventDefault();
                activate(index - 1);
                break;

            case "Enter":
                e.preventDefault();
                const link = rows[index].querySelector(".btn-view");
                if (link) {
                    window.location.href = link.href;
                }
                break;
        }
    });

    // ---------- UPDATE ROWS AFTER SEARCH ----------
    const observer = new MutationObserver(() => {
        rows = Array.from(tbody.querySelectorAll("tr"));
        index = -1;
        keyboardActive = false;
        clearActive();
    });

    observer.observe(tbody, { childList: true });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const c = document.querySelector(".table-container");
    if (!c) return;

    c.addEventListener("scroll", () => {
        c.classList.toggle("scrolled", c.scrollTop > 0);
    });
});
</script>


{% endblock %}
