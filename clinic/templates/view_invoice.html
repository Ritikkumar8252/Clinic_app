{# view_invoice.html #}
{% extends "base.html" %}
{% block body %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/billing.css') }}">

<div class="invoice-view shadow-card">
    <div class="view-header">
        <h2>Invoice: {{ invoice.invoice_number }}</h2>
        <div class="actions-right">
            <a class="btn" href="{{ url_for('billing_bp.download_invoice', id=invoice.id) }}">Download PDF</a>
            <a class="btn-primary" href="{{ url_for('billing_bp.billing') }}">Back</a>
        </div>
    </div>

    <div class="view-grid">
        <div>
            <strong>Patient</strong><br>
            {{ invoice.patient.name }}<br>
            {{ invoice.patient.phone }}<br>
        </div>
        <div>
            <strong>Date</strong><br>
            {{ invoice.created_at }}<br>
            <strong>Due</strong><br>
            {{ invoice.due_date or "-" }}
        </div>
        <div>
            <strong>Status</strong><br>
            <span class="status-badge {% if invoice.status=='Paid' %}paid{% elif invoice.status=='Partial' %}partial{% else %}unpaid{% endif %}">
                {{ invoice.status }}
            </span>
        </div>
    </div>

    <h3>Items</h3>
    <table class="items-table">
        <thead><tr><th>Item</th><th style="text-align:right">Amount</th></tr></thead>
        <tbody>
            {% for it in invoice.items %}
            <tr><td>{{ it.item_name }}</td><td style="text-align:right">₹ {{ "%.2f"|format(it.amount) }}</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="summary-box">
        {% set paid = invoice.payments | sum(attribute='amount') %}
        <div>Total: ₹ {{ "%.2f"|format(invoice.total_amount) }}</div>
        <div>Paid: ₹ {{ "%.2f"|format(paid) }}</div>
        <div><strong>Balance: ₹ {{ "%.2f"|format(invoice.total_amount - (paid or 0)) }}</strong></div>
    </div>

    <h3>Payments</h3>
    <ul>
        {% for p in invoice.payments %}
        <li>₹ {{ "%.2f"|format(p.amount) }} — {{ p.method or "Cash" }} — {{ p.paid_at }}</li>
        {% else %}
        <li>No payments yet</li>
        {% endfor %}
    </ul>
</div>
{% endblock %}
