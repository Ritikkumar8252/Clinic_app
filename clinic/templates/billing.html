{% extends "base.html" %}
{% block body %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/billing.css') }}">
<script src="{{ url_for('static', filename='js/billing.js') }}"></script>

<h2 class="page-title">Billing & Invoices</h2>

<div class="billing-top">
    <div class="left-info">
        <span class="due-label">Due Invoices:</span>
        <span class="due-count">{{ due_count }}</span>
    </div>
    <div class="right-actions">
        <a href="{{ url_for('billing_bp.create_invoice') }}" class="btn-primary">+ Create Invoice</a>
    </div>
</div>

<div class="filter-bar">
    <form method="get" action="{{ url_for('billing_bp.billing') }}">
        <input type="text" name="search" placeholder="Search by patient or invoice" class="search-box" value="{{ request.args.get('search','') }}">
        <select name="status" class="filter-select">
            <option value="">All Status</option>
            <option value="Paid" {% if request.args.get('status')=='Paid' %}selected{% endif %}>Paid</option>
            <option value="Partial" {% if request.args.get('status')=='Partial' %}selected{% endif %}>Partial</option>
            <option value="Unpaid" {% if request.args.get('status')=='Unpaid' %}selected{% endif %}>Unpaid</option>
        </select>
        <button class="btn-filter" type="submit">Filter</button>
    </form>
</div>

<table class="styled-table billing-table">
    <thead>
        <tr>
            <th>Invoice No</th>
            <th>Patient</th>
            <th>Description</th>
            <th>Total</th>
            <th>Status</th>
            <th>Balance</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for inv in invoices %}
        {% set paid = inv.payments | sum(attribute='amount') %}
        {% set balance = inv.total_amount - paid %}
        <tr>
            <td>#{{ inv.invoice_number }}</td>
            <td>{{ inv.patient.name }}</td>
            <td>{{ inv.description }}</td>
            <td>‚Çπ {{ "%.2f"|format(inv.total_amount) }}</td>
            <td><span class="status-badge {% if inv.status=='Paid' %}paid{% elif inv.status=='Partial' %}partial{% else %}unpaid{% endif %}">{{ inv.status }}</span></td>
            <td>‚Çπ {{ "%.2f"|format(balance) }}</td>
            <td>
                <td>
                    <div class="action-menu">
                        <button class="menu-btn">
                            ‚ãÆ
                        </button>

                        <div class="menu-dropdown">
                            <a href="{{ url_for('billing_bp.view_invoice', id=inv.id) }}">
                                üëÅ View Invoice
                            </a>
                            <a href="{{ url_for('billing_bp.download_invoice', id=inv.id) }}">
                                üìÑ Download PDF
                            </a>
                            <a href="{{ url_for('billing_bp.delete_invoice', id=inv.id) }}"
                            onclick="return confirm('Delete this invoice?');">
                                üóë Delete Invoice
                            </a>
                        </div>
                    </div>
                </td>

            </td>
        </tr>
    {% else %}
        <tr><td colspan="7" style="text-align:center; padding:18px;">No invoices found</td></tr>
    {% endfor %}
    </tbody>
</table>

{% endblock %}
