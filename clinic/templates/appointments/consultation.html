{% extends "base.html" %}
{% block body %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/consult.css') }}">

<div class="consult-page"
     data-appt-id="{{ appt.id }}"
     data-prescription-locked="{{ appt.prescription_locked }}">

<!-- ================= TOP BAR ================= -->
<div class="consult-topbar">
    <div class="top-info">
        <h2>Consultation</h2>
        <p>{{ patient.name }} â€¢ {{ patient.gender }}, {{ patient.age }} yrs</p>
    </div>
    <div id="autosaveStatus" class="autosave-status">
        Saved âœ“
    </div>

    <div class="top-actions">
        <button class="btn-save" onclick="sendSaveRequest()">ðŸ’¾ Save</button>

        <a class="btn-complete" href="{{ url_for('appointments_bp.complete', id=appt.id) }}">
            âœ” Finish
        </a>
        <a class="btn-grey"
        href="{{ url_for('appointments_bp.prescription_pdf', id=appt.id) }}?mode=lab"
        {% if appt.prescription_locked %}style="display:none"{% endif %}>
            ðŸ§ª Lab Print
        </a>
        <form method="POST"
              action="{{ url_for('appointments_bp.finalize_prescription', id=appt.id) }}"
              onsubmit="return finalizeAndPrint(event)">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="prescription" id="finalPrescription">
            <button class="btn-pres">âœ” Finalize & Print</button>
        </form>
    </div>
</div>

<!-- ================= MAIN GRID ================= -->
<div class="consult-container">


    <!-- ========== LEFT PANEL ========= -->
    <div class="patient-side">

        <div class="patient-card shadow-card print-prescription">
            <img src="{{ url_for('static', filename='patient_images/' + patient.image) }}"
                 class="patient-photo">

            <h3 class="patient-name">{{ patient.name }}</h3>
            <p class="pt-small">{{ patient.gender }}, {{ patient.age }} yrs</p>
            <p class="pt-small">Phone: {{ patient.phone }}</p>

            <div class="divider"></div>
            <p class="last-visit-title">Last Visit</p>
            <p>{{ patient.last_visit or "â€”" }}</p>
        </div>

        <div class="vitals-card shadow-card print-prescription">
            <h4>Vitals</h4>

            <div class="vital-row"><label>BP</label>
                <input id="bp" value="{{ appt.bp or '' }}" oninput="autoSave()">
            </div>
            <div class="vital-row"><label>Pulse</label>
                <input id="pulse" value="{{ appt.pulse or '' }}" oninput="autoSave()">
            </div>
            <div class="vital-row"><label>SPO2</label>
                <input id="spo2" value="{{ appt.spo2 or '' }}" oninput="autoSave()">
            </div>
            <div class="vital-row"><label>Temp</label>
                <input id="temperature" value="{{ appt.temperature or '' }}" oninput="autoSave()">
            </div>
            <div class="vital-row"><label>Weight</label>
                <input id="weight" value="{{ appt.weight or '' }}" oninput="autoSave()">
            </div>
        </div>

        <div class="followup-card shadow-card print-prescription">
            <h4>Follow Up</h4>

            <input id="follow_up_date"
                type="date"
                value="{{ appt.follow_up_date }}"
                oninput="autoSave()">
        </div>

    </div>

    <!-- ========== MAIN CONSULT AREA ========= -->
    <div class="consult-main">

        <!-- Symptoms -->
        <div class="box shadow-card print-prescription">
            <h3>Symptoms</h3>
            <div class="symptom-actions">
                <button class="btn-grey" type="button" onclick="openSymptomTemplateBox(event)">
                    Templates
                </button>
                
                <button
                    type="button"
                    class="btn-grey"
                    style="margin-bottom: 8px"
                    onclick="saveTemplate()">
                    Save as Template
                </button>
                <div id="symptomTemplateBox" class="template-popup"></div>
            </div>

            


            <div class="voice-field">
                <textarea
                    id="symptoms"
                    rows="4"
                    placeholder="Patient symptoms..."
                    oninput="autoSave()"
                >{{ appt.symptoms or '' }}</textarea>

                <button
                    type="button"
                    class="mic-btn"
                    onclick="startVoice('symptoms', this)">
                    ðŸŽ¤
                </button>
            </div>


        </div>

        <!-- Diagnosis -->
        <div class="box shadow-card print-prescription">
            <h3>Diagnosis</h3>

            <div class="voice-field">
                <textarea
                    id="diagnosis"
                    rows="4"
                    placeholder="Patient Diagnosis..."
                    oninput="autoSave()"
                >{{ appt.diagnosis or '' }}</textarea>

                <button
                    type="button"
                    class="mic-btn"
                    onclick="startVoice('Diagnosis', this)">
                    ðŸŽ¤
                </button>
            </div>


        </div>

        <!-- Lab Tests -->
        <div class="box shadow-card print-prescription lab-section">
            <h3>Lab Tests</h3>
            <div class="voice-field">
                <textarea
                    id="lab_tests"
                    rows="4"
                    placeholder="CBC, LFT, X-Ray Chest..."
                    oninput="autoSave()"
                >{{ appt.lab_tests or '' }}</textarea>

                <button
                    type="button"
                    class="mic-btn"
                    onclick="startVoice('lab_tests', this)">
                    ðŸŽ¤
                </button>
            </div>

        </div>

        <!-- ========== PRESCRIPTION ========= -->
        <div class="box shadow-card print-prescription">

            <div class="prescription-header">
                <h3>Prescription</h3>

                <div class="prescription-actions">
                    <button class="btn-grey" type="button" onclick="openTemplateBox()">
                        Templates
                    </button>
                    <div id="templateBox" class="template-popup"></div>

                    <button class="btn-grey" type="button" onclick="saveAsTemplate()">
                        Save as Template
                    </button>
                </div>

                
            </div>

            <table class="med-table">
                <thead>
                    <tr>
                        <th>Medicine</th>
                        <th>Dose</th>
                        <th>Days</th>
                        <th>Notes</th>
                        <th></th>
                    </tr>
                </thead>

                <tbody id="medBody">
                    {% for m in medicines %}
                    <tr>
                        <td><input value="{{ m.med }}"></td>
                        <td><input value="{{ m.dose }}"></td>
                        <td><input value="{{ m.days }}"></td>
                        <td><input value="{{ m.notes }}"></td>
                        <td>
                            <button class="del-btn" onclick="removeRow(this)">x</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <button id="addRowBtn" class="btn-grey" type="button">
                + Add Medicine
            </button>
        </div>

        <!-- Advice -->
        <div class="box shadow-card print-prescription">
            <h3>Advice</h3>

            <div class="voice-field">
                <textarea
                    id="advice"
                    rows="4"
                    placeholder="Patient Advice..."
                    oninput="autoSave()"
                >{{ appt.advice or '' }}</textarea>

                <button
                    type="button"
                    class="mic-btn"
                    onclick="startVoice('advice', this)">
                    ðŸŽ¤
                </button>
            </div>

        </div>

        

    </div>
</div>

<!-- Toast -->
<div id="saveToast" class="save-toast">Saved</div>

<!-- ================= META + JS ================= -->
<div id="consultMeta"
     data-appt-id="{{ appt.id }}"
     data-autosave-url="{{ url_for('appointments_bp.autosave', id=appt.id) }}">
</div>

<script>
  const meta = document.getElementById("consultMeta");
  window.apptId = meta.dataset.apptId;
  window.autosaveUrl = meta.dataset.autosaveUrl;
  window.prescriptionLocked = "{{ appt.prescription_locked | lower }}";
</script>

<script src="{{ url_for('static', filename='js/appointments/consultation/autosave.js') }}"></script>
<script src="{{ url_for('static', filename='js/appointments/consultation/prescription.js') }}"></script>
<script src="{{ url_for('static', filename='js/appointments/consultation/keyboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/appointments/consultation/voice.js') }}"></script>

<script>
function closeAllTemplatePopups() {
    document
        .querySelectorAll(".template-popup")
        .forEach(popup => popup.style.display = "none");
}

function applySymptomTemplate(text) {
    const textarea = document.getElementById("symptoms");
    textarea.value = text;
    autoSave();
}

function openSymptomTemplateBox(event) {
    event.stopPropagation(); // ðŸ”¥ VERY IMPORTANT

    const box = document.getElementById("symptomTemplateBox");

    fetch("/symptom-templates/search")
        .then(r => r.json())
        .then(data => {

            box.innerHTML = "";

            if (data.length === 0) {
                box.innerHTML = "<div class='template-item'>No templates</div>";
            }

            data.forEach(t => {
                const div = document.createElement("div");
                div.className = "template-item";
                div.innerText = t.name;

                div.addEventListener("click", function (e) {
                    e.stopPropagation(); // ðŸ”¥ CRITICAL
                    applySymptomTemplate(t.content);
                    closeAllTemplatePopups();
                });

                box.appendChild(div);
            });

            box.style.display = "block";
        });
}

// click outside â†’ close popup
document.addEventListener("click", () => {
    closeAllTemplatePopups();
});
</script>


<script>
function saveTemplate() {

    const content = document.getElementById("symptoms").value.trim();

    if (!content) {
        alert("Pehle symptoms likho");
        return;
    }

    const name = prompt("Template name?");
    if (!name) return;

    fetch("/symptom-templates/save", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            name: name,
            content: content
        })
    })
    .then(res => res.json())
    .then(res => {
        if (res.error) {
            alert(res.error);
        } else {
            alert("Symptom template saved");
        }
    });
}
</script>
<script>
let saveTimer = null;

function showSaving() {
    const el = document.getElementById("autosaveStatus");
    if (!el) return;
    el.textContent = "Savingâ€¦";
    el.classList.add("saving");
}

function showSaved() {
    const el = document.getElementById("autosaveStatus");
    if (!el) return;

    const now = new Date();
    const time = now.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
    });

    el.textContent = `Saved âœ“ at ${time}`;
    el.classList.remove("saving");
}

// ðŸ” hook into existing autosave
const originalAutoSave = window.autoSave;
window.autoSave = function () {
    showSaving();

    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
        if (originalAutoSave) originalAutoSave();
        showSaved();
    }, 600);
};
</script>
<!------------ prevent rare data loss -->
<script>
window.addEventListener("beforeunload", function () {
    try {
        sendSaveRequest();
    } catch (e) {}
});
</script>

{% endblock %}
