{% extends "base.html" %}
{% block body %}

<style>
/* ===============================
   STOP PAGE SCROLL
================================ */
html, body {
    height: 100%;
    overflow: hidden;
}

/* ===============================
   PAGE LAYOUT
================================ */
.appt-page {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #f4f7fb;
    padding: 16px 20px;
    box-sizing: border-box;
}

/* ===============================
   STATIC SECTIONS
================================ */
.appt-header,
.filter-bar,
.appt-tabs {
    flex-shrink: 0;
}

/* ===============================
   HEADER
================================ */
.appt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 12px;
}

.appt-header h2 {
    font-size: 24px;
    margin: 0;
}

.subtitle {
    font-size: 14px;
    color: #6b7280;
}

/* ===============================
   BUTTONS
================================ */
.btn {
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    text-decoration: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
}

.btn-primary { background: #2563eb; color: #fff; }
.btn-green { background: #16a34a; color: #fff; }
.btn-reset {
    background: #ae5b5b;
    border: 2px solid #0f1217;
    color: white;
}

/* ===============================
   FILTER
================================ */
.filter-bar {
    background: #fff;
    padding: 14px 16px;
    border-radius: 12px;
    margin: 14px 0;
    box-shadow: 0 6px 18px rgba(0,0,0,0.05);
}

.filter-form {
    display: flex;
    gap: 12px;
    align-items: center;
}

.search-box,
.date-box {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
}

/* ===============================
   TABS
================================ */
.appt-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.tab {
    padding: 8px 16px;
    border-radius: 999px;
    background: #e5e7eb;
    color: #374151;
    text-decoration: none;
}

.tab.active {
    background: #2563eb;
    color: #fff;
}

/* ===============================
   SCROLL AREA (ONLY LIST)
================================ */
.table-scroll {
    flex: 1;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    overflow-y: auto;
}

/* ===============================
   TABLE
================================ */
.appointments-table {
    width: 100%;
    border-collapse: collapse;
    user-select: none;
}

/* sticky header */
.appointments-table thead th {
    position: sticky;
    top: 0;
    background: #f9fafb;
    z-index: 5;
    padding: 12px 14px;
    font-size: 12px;
    text-transform: uppercase;
    color: #6b7280;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
}

/* table cells */
.appointments-table td {
    padding: 12px 14px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 14px;
    vertical-align: middle;
}

/* ===============================
   KEYBOARD ACTIVE ROW
================================ */
.appointments-table tbody tr {
    outline: none;
}

.appointments-table tbody tr.kb-active {
    background: #eef3ff;
    box-shadow: inset 4px 0 0 #2563eb;
}

.appointments-table tbody tr.kb-active td {
    font-weight: 500;
}

/* ===============================
   PATIENT CELL
================================ */
.patient-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.patient-mini {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #e5e7eb;
}

.subtext {
    font-size: 12px;
    color: #6b7280;
}

/* ===============================
   ADDRESS
================================ */
.address-cell {
    font-size: 13px;
    color: #6b7280;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ===============================
   VISIT BADGE
================================ */
.visit-badge {
    padding: 5px 12px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
}

.visit-new { background: #ecfeff; color: #0369a1; }
.visit-followup { background: #fef3c7; color: #92400e; }
.visit-walkin { background: #ecfdf5; color: #047857; }

/* ===============================
   DROPDOWN
================================ */
.dropdown {
    position: relative;
}

.menu-btn {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

.dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 26px;
    background: #fff;
    border-radius: 10px;
    min-width: 180px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    z-index: 10;
}

.dropdown:hover .dropdown-menu {
    display: block;
}

.dropdown-menu a {
    display: block;
    padding: 10px 14px;
    font-size: 14px;
    text-decoration: none;
    color: #111827;
}

.dropdown-menu a:hover {
    background: #f1f5f9;
}

.dropdown-menu .danger {
    color: #b91c1c;
}

/* ===============================
   EMPTY
================================ */
.empty-state {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}
</style>

<div class="appt-page">

    <!-- HEADER -->
    <div class="appt-header">
        <div>
            <h2>Appointments</h2>
            <p class="subtitle">Welcome Dr. {{ session['user_email'] }}</p>
        </div>
        <div>
            <a href="{{ url_for('appointments_bp.add_appointment') }}" class="btn btn-primary">
                + Add Appointment
            </a>
            <a href="{{ url_for('appointments_bp.walkin') }}" class="btn btn-green">
                Walk-In Consultation
            </a>
        </div>
    </div>

    <!-- FILTER -->
    <div class="filter-bar">
        <form method="GET" class="filter-form">
            <input type="hidden" name="tab" value="{{ tab }}">
            <input type="text" name="search" value="{{ search }}" class="search-box" placeholder="Search patient">
            <input type="date" name="date" value="{{ date_filter }}" class="date-box">
            <button class="btn btn-primary">Filter</button>
            <a href="{{ url_for('appointments_bp.appointments') }}" class="btn btn-reset">Reset</a>
        </form>
    </div>

    <!-- TABS -->
    <div class="appt-tabs">
        <a class="tab {{ 'active' if tab=='queue' else '' }}" href="?tab=queue">Queue</a>
        <a class="tab {{ 'active' if tab=='inprogress' else '' }}" href="?tab=inprogress">In Progress</a>
        <a class="tab {{ 'active' if tab=='completed' else '' }}" href="?tab=completed">Completed</a>
        <a class="tab {{ 'active' if tab=='cancelled' else '' }}" href="?tab=cancelled">Cancelled</a>
    </div>

    <!-- SCROLLABLE LIST -->
    <div class="table-scroll">
        <table class="appointments-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Patient</th>
                    <th>Address</th>
                    <th>Date & Time</th>
                    <th>Visit</th>
                    <th style="text-align:center;">Actions</th>
                </tr>
            </thead>

            <tbody>
            {% for a in (queue if tab=='queue' else inprogress if tab=='inprogress' else completed if tab=='completed' else cancelled) %}
                <tr
                    tabindex="0"
                    data-start="{{ url_for('appointments_bp.start', id=a.id) }}"
                    data-view="{{ url_for('patients_bp.patient_profile', id=a.patient.id) }}"
                    data-cancel="{{ url_for('appointments_bp.cancel', id=a.id) }}"
                >
                    <td>{{ loop.index }}</td>
                    <td>
                        <div class="patient-info">
                            <img src="{{ url_for('static', filename='patient_images/' + a.patient.image) }}" class="patient-mini">
                            <div>
                                <strong>{{ a.patient.name }}</strong>
                                <p class="subtext">{{ a.patient.gender }}, {{ a.patient.age }} yrs</p>
                            </div>
                        </div>
                    </td>
                    <td class="address-cell">
                        {{ a.patient.city }}{% if a.patient.state %}, {{ a.patient.state }}{% endif %}
                    </td>
                    <td>
                        {{ a.date }}<br>{{ a.time.strftime("%I:%M %p") }}
                    </td>
                    <td>
                        <span class="visit-badge
                            {% if a.type=='New' %}visit-new
                            {% elif a.type=='Follow-up' %}visit-followup
                            {% elif a.type=='Walk-in' %}visit-walkin
                            {% endif %}">
                            {{ a.type }}
                        </span>
                    </td>
                    <td style="text-align:center;">
                        <div class="dropdown">
                            <button class="menu-btn">⋮</button>
                            <div class="dropdown-menu">
                                <a href="{{ url_for('patients_bp.patient_profile', id=a.patient.id) }}">View Patient</a>
                                <a href="{{ url_for('appointments_bp.start', id=a.id) }}">Start Consultation</a>
                                <a href="{{ url_for('appointments_bp.cancel', id=a.id) }}" class="danger">Cancel Appointment</a>
                            </div>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="6" class="empty-state">No appointments found</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /* ===============================
       ELEMENTS
    =============================== */
    const searchInput = document.querySelector(".search-box");
    const dateInput   = document.querySelector(".date-box");
    const form        = document.querySelector(".filter-form");
    const container   = document.querySelector(".table-scroll");
    const tableBody   = document.querySelector(".appointments-table tbody");

    if (!tableBody || !container) return;

    let allRows = Array.from(tableBody.querySelectorAll("tr"));
    let rows = [...allRows];
    let index = -1;
    let tableFocused = false;

    /* ===============================
       TABLE FOCUS CONTROL
    =============================== */
    container.addEventListener("click", () => {
        tableFocused = true;
        if (index === -1 && rows.length) {
            activate(0);
        }
    });

    document.addEventListener("click", e => {
        if (!container.contains(e.target)) {
            tableFocused = false;
            clearActive();
        }
    });

    /* ===============================
       ROW HIGHLIGHT + SCROLL
    =============================== */
    function activate(i) {
        clearActive();
        if (!rows.length) return;

        index = Math.max(0, Math.min(i, rows.length - 1));
        const row = rows[index];
        row.classList.add("kb-active");

        const rowTop = row.offsetTop;
        const rowBottom = rowTop + row.offsetHeight;
        const viewTop = container.scrollTop;
        const viewBottom = viewTop + container.clientHeight;

        if (rowTop < viewTop) {
            container.scrollTop = rowTop;
        } else if (rowBottom > viewBottom) {
            container.scrollTop = rowBottom - container.clientHeight;
        }
    }

    function clearActive() {
        rows.forEach(r => r.classList.remove("kb-active"));
        index = -1;
    }

    /* ===============================
       SEARCH FILTER (FRONTEND ONLY)
    =============================== */
    function applyFilter() {
        const query = searchInput.value.toLowerCase().trim();
        rows = [];

        allRows.forEach(row => {
            const show = row.innerText.toLowerCase().includes(query);
            row.style.display = show ? "" : "none";
            if (show) rows.push(row);
        });

        clearActive();
    }

    if (searchInput) {
        searchInput.addEventListener("input", applyFilter);
    }

    /* ===============================
       DATE CHANGE (BACKEND RELOAD)
    =============================== */
    if (dateInput && form) {
        dateInput.addEventListener("change", () => {
            form.submit();
        });
    }

    /* ===============================
       KEYBOARD NAVIGATION (SAFE)
    =============================== */
    document.addEventListener("keydown", e => {

        // do nothing if user is typing
        if (document.activeElement !== document.body) return;

        if (!tableFocused || !rows.length) return;

        if (e.key === "ArrowDown") {
            e.preventDefault();
            activate(index === -1 ? 0 : index + 1);
        }

        if (e.key === "ArrowUp") {
            e.preventDefault();
            activate(index === -1 ? 0 : index - 1);
        }

        if (e.key === "Escape") {
            clearActive();
        }

        if (index === -1) return;

        const current = rows[index];

        if (e.key === "Enter" && current.dataset.start) {
            window.location.href = current.dataset.start;
        }

        if (e.key.toLowerCase() === "v" && current.dataset.view) {
            window.location.href = current.dataset.view;
        }

        if (
            e.key.toLowerCase() === "c" &&
            current.dataset.cancel &&
            confirm("Cancel this appointment?")
        ) {
            window.location.href = current.dataset.cancel;
        }
    });

});
</script>



{% endblock %}


<!-- 

↑ / ↓  → Navigate appointments
Enter → Start consultation
V     → View patient
C     → Cancel appointment
Esc   → Clear selection

-->