{% extends "base.html" %}
{% block body %}

<style>
/* ===============================
   APPOINTMENTS – PATIENT STYLE
================================ */

/* Disable text selection */
.appt-header,
.appt-header *,
.filter-bar,
.filter-bar *,
.appt-tabs,
.appt-tabs *,
.table-scroll,
.table-scroll *,
.appointments-table,
.appointments-table * {
    user-select: none;
    cursor: default;
}

/* ===============================
   FIXED HEADER (STICKY)
================================ */
.appt-fixed-header {
    position: sticky;
    top: 0;
    z-index: 20;
    background: #f4f7fb;
    padding-bottom: 14px;
}

/* ===============================
   HEADER
================================ */
.appt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 12px;
}

.appt-header h2 {
    font-size: 24px;
    margin: 0;
}

.subtitle {
    font-size: 14px;
    color: #6b7280;
}

/* ===============================
   BUTTONS
================================ */
.btn {
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    text-decoration: none;
    cursor: pointer;
}

.btn-primary { background: #2563eb; color: #fff; }
.btn-green { background: #16a34a; color: #fff; }
.btn-reset {
    background: #ae5b5b;
    border: 2px solid #0f1217;
    color: white;
}

/* ===============================
   FILTER
================================ */
.filter-bar {
    background: #fff;
    padding: 14px 16px;
    border-radius: 12px;
    margin: 14px 0;
    box-shadow: 0 6px 18px rgba(0,0,0,0.05);
}

.filter-form {
    display: flex;
    gap: 12px;
    align-items: center;
}

.search-box,
.date-box {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    user-select: text;
    cursor: text;
}

/* ===============================
   TABS
================================ */
.appt-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.tab {
    padding: 8px 16px;
    border-radius: 999px;
    background: #e5e7eb;
    color: #374151;
    text-decoration: none;
}

.tab.active {
    background: #2563eb;
    color: #fff;
}

/* ===============================
   SCROLLING TABLE (KEY FIX)
================================ */
.table-scroll {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    overflow-y: auto;
    max-height: calc(100vh - 360px); /* SAME IDEA AS PATIENTS */
}

/* ===============================
   TABLE
================================ */
.appointments-table {
    width: 100%;
    border-collapse: collapse;
}

/* sticky table header */
.appointments-table thead th {
    position: sticky;
    top: 0;
    background: #f9fafb;
    z-index: 5;
    padding: 12px 14px;
    font-size: 12px;
    text-transform: uppercase;
    color: #6b7280;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
}

/* table cells */
.appointments-table td {
    padding: 12px 14px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 14px;
}

/* ===============================
   ACTIVE ROW
================================ */
.appointments-table tbody tr.kb-active {
    background: #eef3ff;
    box-shadow: inset 4px 0 0 #2563eb;
}

/* ===============================
   EMPTY
================================ */
.empty-state {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}
</style>

<div class="appt-page">

    <!-- HEADER -->
    <div class="appt-header">
        <div>
            <h2>Appointments</h2>
            <p class="subtitle">Welcome Dr. {{ session['user_email'] }}</p>
        </div>
        <div>
            <a href="{{ url_for('appointments_bp.add_appointment') }}" class="btn btn-primary">
                + Add Appointment
            </a>
            <a href="{{ url_for('appointments_bp.walkin') }}" class="btn btn-green">
                Walk-In Consultation
            </a>
        </div>
    </div>

    <!-- FILTER -->
    <div class="filter-bar">
        <form method="GET" class="filter-form">
            <input type="hidden" name="tab" value="{{ tab }}">
            <input type="text" name="search" value="{{ search }}" class="search-box" placeholder="Search patient">
            <input type="date" name="date" value="{{ date_filter }}" class="date-box">
            <button class="btn btn-primary">Filter</button>
            <a href="{{ url_for('appointments_bp.appointments') }}" class="btn btn-reset">Reset</a>
        </form>
    </div>

    <!-- TABS -->
    <div class="appt-tabs">
        <a class="tab {{ 'active' if tab=='queue' else '' }}" href="?tab=queue">Queue</a>
        <a class="tab {{ 'active' if tab=='inprogress' else '' }}" href="?tab=inprogress">In Progress</a>
        <a class="tab {{ 'active' if tab=='completed' else '' }}" href="?tab=completed">Completed</a>
        <a class="tab {{ 'active' if tab=='cancelled' else '' }}" href="?tab=cancelled">Cancelled</a>
    </div>

    <!-- SCROLLABLE LIST -->
    <div class="table-scroll">
        <table class="appointments-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Patient</th>
                    <th>Address</th>
                    <th>Date & Time</th>
                    <th>Visit</th>
                    <th style="text-align:center;">Actions</th>
                </tr>
            </thead>

            <tbody>
            {% for a in (queue if tab=='queue' else inprogress if tab=='inprogress' else completed if tab=='completed' else cancelled) %}
                <tr
                    tabindex="0"
                    data-start="{{ url_for('appointments_bp.start', id=a.id) }}"
                    data-view="{{ url_for('patients_bp.patient_profile', id=a.patient.id) }}"
                    data-cancel="{{ url_for('appointments_bp.cancel', id=a.id) }}"
                >
                    <td>{{ loop.index }}</td>
                    <td>
                        <div class="patient-info">
                            <img src="{{ url_for('static', filename='patient_images/' + a.patient.image) }}" class="patient-mini">
                            <div>
                                <strong>{{ a.patient.name }}</strong>
                                <p class="subtext">{{ a.patient.gender }}, {{ a.patient.age }} yrs</p>
                            </div>
                        </div>
                    </td>
                    <td class="address-cell">
                        {{ a.patient.city }}{% if a.patient.state %}, {{ a.patient.state }}{% endif %}
                    </td>
                    <td>
                        {{ a.date }}<br>{{ a.time.strftime("%I:%M %p") }}
                    </td>
                    <td>
                        <span class="visit-badge
                            {% if a.type=='New' %}visit-new
                            {% elif a.type=='Follow-up' %}visit-followup
                            {% elif a.type=='Walk-in' %}visit-walkin
                            {% endif %}">
                            {{ a.type }}
                        </span>
                    </td>
                    <td style="text-align:center;">
                        <div class="dropdown">
                            <button class="menu-btn">⋮</button>
                            <div class="dropdown-menu">
                                <a href="{{ url_for('patients_bp.patient_profile', id=a.patient.id) }}">View Patient</a>
                                <a href="{{ url_for('appointments_bp.start', id=a.id) }}">Start Consultation</a>
                                <a href="{{ url_for('appointments_bp.cancel', id=a.id) }}" class="danger">Cancel Appointment</a>
                            </div>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="6" class="empty-state">No appointments found</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const searchInput = document.querySelector(".search-box");
    const dateInput   = document.querySelector(".date-box");
    const form        = document.querySelector(".filter-form");
    const container   = document.querySelector(".table-scroll");
    const tableBody   = document.querySelector(".appointments-table tbody");

    if (!tableBody || !container) return;

    let allRows = Array.from(tableBody.querySelectorAll("tr"));
    let rows = [...allRows];
    let index = -1;
    let tableFocused = false;

    /* ===============================
       RESET VISIBILITY
    =============================== */
    function resetTableVisibility() {
        allRows.forEach(r => r.style.display = "");
        rows = [...allRows];
        clearActive();
    }

    resetTableVisibility();

    /* ===============================
       FOCUS HANDLING (IMPORTANT)
    =============================== */
    container.addEventListener("mouseenter", () => {
        tableFocused = true;
    });

    container.addEventListener("mouseleave", () => {
        tableFocused = false;
        clearActive();
    });

    /* ===============================
       ROW SELECTION + SMOOTH SCROLL
    =============================== */
    function activate(i) {
        if (!rows.length) return;

        clearActive();
        index = Math.max(0, Math.min(i, rows.length - 1));

        const row = rows[index];
        row.classList.add("kb-active");

        // ----- FIX: scroll INSIDE container only -----
        const rowTop = row.offsetTop;
        const rowBottom = rowTop + row.offsetHeight;

        const viewTop = container.scrollTop;
        const viewBottom = viewTop + container.clientHeight;

        if (rowTop < viewTop) {
            container.scrollTop = rowTop;
        } else if (rowBottom > viewBottom) {
            container.scrollTop = rowBottom - container.clientHeight;
        }
    }


    function clearActive() {
        rows.forEach(r => r.classList.remove("kb-active"));
        index = -1;
    }

    /* ===============================
       SEARCH FILTER
    =============================== */
    function applyFilter() {
        resetTableVisibility();

        const q = searchInput.value.toLowerCase().trim();
        rows = [];

        allRows.forEach(row => {
            const show = row.innerText.toLowerCase().includes(q);
            row.style.display = show ? "" : "none";
            if (show) rows.push(row);
        });
    }

    searchInput?.addEventListener("input", applyFilter);

    /* ===============================
       DATE CHANGE (BACKEND)
    =============================== */
    dateInput?.addEventListener("change", () => {
        resetTableVisibility();
        form.submit();
    });

    /* ===============================
       TAB CLICK FIX
    =============================== */
    document.addEventListener("click", e => {
        if (e.target.closest(".tab")) {
            resetTableVisibility();
        }
    });

    /* ===============================
       KEYBOARD CONTROLS (PERFECT)
    =============================== */
    document.addEventListener("keydown", e => {

        // Don't interfere with typing
        if (["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) return;
        if (!rows.length) return;

        switch (e.key) {

            case "ArrowDown":
                e.preventDefault();
                activate(index === -1 ? 0 : index + 1);
                break;

            case "ArrowUp":
                e.preventDefault();
                activate(index === -1 ? 0 : index - 1);
                break;

            case "Enter":
                if (index !== -1 && rows[index].dataset.start) {
                    window.location.href = rows[index].dataset.start;
                }
                break;

            case "Escape":
                clearActive();
                break;
        }
    });

});
</script>





{% endblock %}


<!-- 

↑ / ↓  → Navigate appointments
Enter → Start consultation
V     → View patient
C     → Cancel appointment
Esc   → Clear selection

-->