{% extends "base.html" %}
{% block body %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/billing.css') }}">

<div class="invoice-view shadow-card">

    <!-- HEADER -->
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Invoice - {{ inv.invoice_number }}</h2>
        <div>
            <a class="btn-secondary"
               href="{{ url_for('billing_bp.download_invoice', id=inv.id) }}"
               target="_blank">
               Print / PDF
            </a>

            {% if not inv.is_locked %}
                <a class="btn-primary"
                   href="{{ url_for('billing_bp.edit_invoice', id=inv.id) }}">
                   Edit
                </a>
            {% endif %}
        </div>
    </div>

    <!-- META -->
    <div style="display:flex; justify-content:space-between; margin-top:12px;">
        <div>
            <strong>Patient:</strong> {{ inv.patient.name }}<br>
            <strong>Phone:</strong> {{ inv.patient.phone or "-" }}
        </div>
        <div>
            <strong>Date:</strong> {{ inv.created_at.strftime('%d-%m-%Y') }}<br>
            <strong>Status:</strong>
            {% if inv.is_locked %}
                <span style="color:green; font-weight:bold;">Paid</span>
            {% elif inv.status == "Partial" %}
                <span style="color:orange;">Partial</span>
            {% else %}
                <span style="color:red;">Unpaid</span>
            {% endif %}
        </div>
    </div>

    <hr>

    <!-- ITEMS -->
    <table class="items-table">
        <thead>
            <tr>
                <th>Item</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for it in inv.items %}
            <tr>
                <td>{{ it.item_name }}</td>
                <td>₹ {{ "%.2f"|format(it.amount) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- TOTALS -->
    <div style="display:flex; justify-content:flex-end; margin-top:12px;">
        <div style="text-align:right;">
            <div><strong>Total:</strong> ₹ {{ "%.2f"|format(inv.total_amount) }}</div>
            <div><strong>Paid:</strong> ₹ {{ "%.2f"|format(paid) }}</div>
            <div><strong>Balance:</strong> ₹ {{ "%.2f"|format(balance) }}</div>
        </div>
    </div>

    <!-- PAY BUTTON -->
    <div style="margin-top:16px;">
        {% if not inv.is_locked and balance > 0 %}
            <button class="btn-primary" onclick="openPaymentModal()">
                Pay Bill
            </button>
        {% else %}
            <span style="color:green; font-weight:bold;">
                Invoice Fully Paid ✔
            </span>
        {% endif %}
    </div>

    <!-- PAYMENTS LIST -->
    <h3 style="margin-top:20px;">Payments</h3>
    <table class="items-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
            </tr>
        </thead>
        <tbody>
            {% for p in inv.payments %}
            <tr>
                <td>{{ p.paid_at.strftime('%d-%m-%Y') }}</td>
                <td>₹ {{ "%.2f"|format(p.amount) }}</td>
                <td>{{ p.method }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3" style="text-align:center;">
                    No payments recorded
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closePaymentModal()">×</span>

        <h3>Pay Invoice</h3>

        <form method="POST"
              action="{{ url_for('billing_bp.add_payment', id=inv.id) }}">

            <div class="form-group">
                <label>Amount (Remaining: ₹ {{ "%.2f"|format(balance) }})</label>
                <input type="number"
                       name="amount"
                       step="0.01"
                       max="{{ balance }}"
                       required>
            </div>

            <div class="form-group">
                <label>Method</label>
                <select name="method">
                    <option value="Cash">Cash</option>
                    <option value="UPI">UPI</option>
                    <option value="Card">Card</option>
                </select>
            </div>

            <button class="btn-primary" type="submit">
                Save Payment
            </button>
        </form>
    </div>
</div>

<!-- MODAL JS (UI ONLY) -->
<script>
function openPaymentModal() {
    document.getElementById("paymentModal").style.display = "flex";
}
function closePaymentModal() {
    document.getElementById("paymentModal").style.display = "none";
}
</script>

{% endblock %}
