{% extends "base.html" %}
{% block body %}

<style>
/* ---------- BILLING PAGE UI ---------- */
.page-title {
    font-size: 26px;
    font-weight: 600;
    margin-bottom: 15px;
}

/* Top summary bar */
.billing-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
}

.due-label {
    font-weight: 600;
}

.due-count {
    background: #ff4d4d;
    padding: 3px 10px;
    color: white;
    border-radius: 8px;
    margin-left: 6px;
}

/* Filter bar */
.filter-bar {
    background: white;
    padding: 14px;
    border-radius: 10px;
    margin-bottom: 18px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.search-box {
    padding: 9px;
    width: 230px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

.filter-select {
    padding: 9px;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-left: 8px;
}

.btn-filter {
    padding: 8px 15px;
    margin-left: 10px;
    border: none;
    background: #005eff;
    color: white;
    border-radius: 8px;
    cursor: pointer;
}

/* Table */
.billing-table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}

.billing-table th {
    background: #f5f6fa;
    padding: 14px;
    text-align: left;
    font-weight: 600;
}

.billing-table td {
    padding: 14px;
    border-bottom: 1px solid #f0f0f0;
}

/* Status badges */
.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
}
.status-badge.paid { background: #d4f8d4; color: #1d7e1d; }
.status-badge.partial { background: #fff3cd; color: #a67c00; }
.status-badge.unpaid { background: #fde0e0; color: #cc1f1f; }

/* Action menu */
.action-menu {
    position: relative;
    display: inline-block;
}

.menu-btn {
    border: none;
    background: transparent;
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
}

.menu-dropdown {
    position: absolute;
    top: 28px;
    right: 0;
    width: 170px;
    background: white;
    border-radius: 10px;
    box-shadow: 0px 4px 12px rgba(0,0,0,0.2);
    display: none;
    overflow: visible;
    z-index: 999;
}

.menu-dropdown a {
    padding: 12px;
    display: block;
    color: #333;
    text-decoration: none;
    font-size: 14px;
}

.menu-dropdown a:hover {
    background: #f5f5f5;
}

.menu-dropdown.show {
    display: block;
}

.billing-table {
    overflow: visible !important;
}

.billing-table tbody {
    overflow: visible !important;
}

td, tr {
    overflow: visible !important;
    position: relative;
}
/* create invoice */
.right-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.btn-primary {
    background: #2563eb;
    color: white;
    padding: 10px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: 0.2s;
}

.btn-primary:hover {
    background: #1e50c2;
}

</style>



<h2 class="page-title">Billing & Invoices</h2>
   
<div class="billing-top">
    <div class="left-info">
        <span class="due-label">Due Invoices:</span>
        <span class="due-count">{{ due_count }}</span>
    </div>
    <div class="right-actions">
        <a href="{{ url_for('billing_bp.create_invoice') }}" class="btn-primary">+ Create Invoice</a>
    </div>
</div>


<!-- FILTER BAR -->
<div class="filter-bar">
    <form method="get" action="{{ url_for('billing_bp.billing') }}">
        <input type="text" name="search" placeholder="Search by patient or invoice"
               class="search-box"
               value="{{ request.args.get('search','') }}">

        <select name="status" class="filter-select">
            <option value="">All Status</option>
            <option value="Paid" {% if request.args.get('status')=='Paid' %}selected{% endif %}>Paid</option>
            <option value="Partial" {% if request.args.get('status')=='Partial' %}selected{% endif %}>Partial</option>
            <option value="Unpaid" {% if request.args.get('status')=='Unpaid' %}selected{% endif %}>Unpaid</option>
        </select>

        <button class="btn-filter" type="submit">Filter</button>
    </form>
</div>



<!-- TABLE -->
<table class="billing-table">
    <thead>
        <tr>
            <th>Invoice No</th>
            <th>Patient</th>
            <th>Description</th>
            <th>Total</th>
            <th>Status</th>
            <th>Balance</th>
            <th>Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for inv in invoices %}
            {% set paid = inv.payments | sum(attribute='amount') %}
            {% set balance = inv.total_amount - paid %}

            <tr>
                <td>#{{ inv.invoice_number }}</td>
                <td>{{ inv.patient.name }}</td>
                <td>{{ inv.description }}</td>
                <td>‚Çπ {{ "%.2f"|format(inv.total_amount) }}</td>
                <td>
                    <span class="status-badge 
                        {% if inv.status=='Paid' %}paid
                        {% elif inv.status=='Partial' %}partial
                        {% else %}unpaid
                        {% endif %}
                    ">
                        {{ inv.status }}
                    </span>
                </td>
                <td>‚Çπ {{ "%.2f"|format(balance) }}</td>

                <!-- FIXED ACTION BUTTON -->
                <td class="actions">
                    <div class="action-menu">
                        <button class="menu-btn">‚ãÆ</button>

                        <div class="menu-dropdown">
                            <a href="{{ url_for('billing_bp.view_invoice', id=inv.id) }}">üëÅ View Invoice</a>
                            <a href="{{ url_for('billing_bp.download_invoice', id=inv.id) }}">üìÑ Download PDF</a>
                            <a href="{{ url_for('billing_bp.delete_invoice', id=inv.id) }}"
                               onclick="return confirm('Delete invoice?');">
                               üóë Delete Invoice
                            </a>
                        </div>
                    </div>
                </td>
            </tr>

        {% else %}
            <tr>
                <td colspan="7" style="text-align:center; padding:18px;">
                    No invoices found
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>



<script>
// Close all dropdowns if clicking elsewhere
document.addEventListener("click", () => {
    document.querySelectorAll(".menu-dropdown").forEach(menu => menu.classList.remove("show"));
});

// Toggle dropdown on click
document.addEventListener("click", function (e) {
    const btn = e.target.closest(".menu-btn");
    if (btn) {
        e.stopPropagation();
        let menu = btn.nextElementSibling;
        menu.classList.toggle("show");
    }
});
</script>


{% endblock %}
